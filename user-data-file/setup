#!/bin/bash
# Install keys.
curl -L https://put-keys-here.com/keys >> /home/ubuntu/.ssh/authorized_keys
curl -L https://put-keys-here.com/gitreceive-keys >> /home/git/.ssh/authorized_keys
# Setup domain name.
sed "s/\$PUBLIC_IP\.xip\.io/domain-name-goes-here\.com/" /usr/bin/octo --in-place
sed "s/DOMAIN_SUFFIX=\"\$PUBLIC_IP\.xip\.io/DOMAIN_SUFFIX=\"domain-name-goes-here\.com/" /home/git/receiver --in-place
# Get IP address for etcd and set it up.
IP_ADDRESS=$(curl http://169.254.169.254/latest/meta-data/local-ipv4)
DISCOVERY_URL="get-one-at-http://discovery.etcd.io/new"
sudo cat > /etc/init/etcd.conf << EOL
description "etcd service registry"

start on started networking
stop on shutdown

exec /usr/local/bin/etcd  -name octohost-1 -peer-addr $IP_ADDRESS:7001 -addr $IP_ADDRESS:4001 -snapshot=true -data-dir /var/cache/etcd/octohost -discovery $DISCOVERY_URL
EOL
service etcd restart
#
# To remove a dead etcd member: curl -L -X DELETE 127.0.0.1:7001/remove/octohost-{#}
#
